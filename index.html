:                 </div>
            </div>
        </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, query, where, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- APP Configuration (Will be dynamically loaded) ---
        let  Firestore Document ID
            photoUrl: 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png',
            points: 0,
            adsWatchedToday: 0,
            totalAdsWatchedLifetime: 0,
            lastAdWatchDate: null,
            claimedBonuses: [],
            referralCode: '',
            referredBy: null,
            referredUsers: [] // Store codes or just count/fetch on demand
        };
        
        // existingUserDoc.data();
                    userId = existingUserDoc.id;
                } else {
                    // New user creation (Use Telegram ID as primary key if possible, or a new document)
                    userId = tgUser.id.toString(); // Use Telegram ID as document ID for simplicity in this TWA context
                    initialData = {
                        name: `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim() || `User${tgUser.id}`,
                        telegramId: tgUser.id,
                        photoUrl: tgUser.photo_url || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png',
                        points: 0,
                        adsWatchedToday: 0,
                        totalAdsWatchedLifetime: 0,
                        lastAdWatchDate: null,
                        claimedBonuses: [],
                        referralCode: generateReferralCode(),
                        referredBy: null,
                        referredUsers: [],
                        createdAt: serverTimestamp()
                    };
                    await setDoc(doc(db, "users", userId), initialData);
                }
                
                currentUser = { ...currentUser, ...initialData, userId };
                userDocRef = doc(db, "users", userId);
                
                // Set up real-time listener for current user state
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentUser = { ...currentUser, ...docSnap.data(), userId: docSnap.id };
                        updateUI();
                    }
                });

            } else {
                // Fallback for non-TWA/Guest User (Simple LocalStorage Bridge)
                userId = localStorage.getItem('galaxyEarnGuestId');
                if (!userId) {
                    userId = `guest_${generateReferralCode()}`;
                    localStorage.setItem('galaxyEarnGuestId', userId);
                }
                
                let guestData = JSON.parse(localStorage.getItem(`galaxyEarnUser_${userId}`)) || {
                    name: 'Guest User', telegramId: null, userId: userId, photoUrl: currentUser.photoUrl,
                    points: 0, adsWatchedToday: 0, totalAdsWatchedLifetime: 0, lastAdWatchDate: null,
                    claimedBonuses: [], referralCode: generateReferralCode(), referredBy: null, referredUsers: []
                };
                currentUser = guestData;
                showToast("Running in Guest Mode (Local Storage). Admin changes won't apply to this data.");
            }

            // Apply referral if present in URL
            const urlParams = new URLSearchParams(window.location.search);
            const refCodeFromUrl = urlParams.get('start') || urlParams.get('ref');

            if (refCodeFromUrl && !currentUser.referredBy && refCodeFromUrl !== currentUser.referralCode) {
                await applyReferral(refCodeFromUrl);
            }

            updateUI();
        }

        // Save user state (Local Storage for Guest, Firebase for TWA)
        async function saveUserState() {
            if (userDocRef) {
                // TWA User: Save to Firebase
                const userDataToSave = { ...currentUser };
                delete userDataToSave.userId; // Don't save doc ID inside the document
                try {
                    await updateDoc(userDocRef, userDataToSave);
                } catch (error) {
                    console.error("Error saving user state to Firebase:", error);
                    showToast("Error saving progress to server!");
                }
            } else {
                // Guest User: Save to Local Storage
                localStorage.setItem(`galaxyEarnUser_${currentUser.userId}`, JSON.stringify(currentUser));
            }
        }

        // Apply referral code (simplified to update Firebase directly)
        async function applyReferral(referrerCode) {
            if (referrerCode === currentUser.referralCode || currentUser.referredBy) {
                return;
            }

            // Find referrer by code
            const referrerQuery = query(collection(db, "users"), where("referralCode", "==", referrerCode));
            const referrerSnapshot = await getDoc(referrerQuery);
            let referrerDoc;
            referrerSnapshot.forEach(doc => { referrerDoc = doc; });

            if (referrerDoc) {
                const referrerUser = referrerDoc.data();
                const referrerRef = doc(db, "users", referrerDoc.id);

                // Update referee (current user)
                currentUser.points += GLOBAL_CONFIG.REFERRAL_BONUS_REFEREE;
                currentUser.referredBy = referrerCode;
                await saveUserState(); // Save current user changes

                // Update referrer (transactionally is better, but simplifying here)
                const referredUsers = referrerUser.referredUsers || [];
                if (!referredUsers.includes(currentUser.referralCode)) {
                    referredUsers.push(currentUser.referralCode);
                    await updateDoc(referrerRef, {
                        points: (referrerUser.points || 0) + GLOBAL_CONFIG.REFERRAL_BONUS_REFERRER,
                        referredUsers: referredUsers
                    });
                }
                
                showToast(`+${GLOBAL_CONFIG.REFERRAL_BONUS_REFEREE} bonus points for joining via referral!`);
                sendTelegramReferralNotification(
                    currentUser.name,
                    currentUser.referralCode,
                    referrerUser.name,
                    referrerCode
                );
            } else {
                console.warn(`Referrer with code ${referrerCode} not found.`);
                showToast("Invalid referral code.");
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async () => {
            // 6-second loading screen
            await fetchAppConfig(); // Fetch config first
            
            setTimeout(async () => {
                loadingPage.style.opacity = '0';
                setTimeout(() => {
                    loadingPage.style.display = 'none';
                    appContainer.style.display = 'block';
                }, 500); // Wait for fade-out transition
                
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.expand();
                    Telegram.WebApp.enableClosingConfirmation();
                }

                await loadUserState();
                applyTheme(localStorage.getItem('galaxyEarnTheme') || 'light'); // Default to light mode for "normal"

                navigateTo('home');

                themeToggleBtn.addEventListener('click', toggleTheme);
                document.getElementById('editNameBtn').addEventListener('click', promptForNewName);
                bottomNavItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = item.dataset.page;
                        navigateTo(page);
                    });
                });
                adCloseBtn.addEventListener('click', closeAdModalAndReward);
            }, 6000); // 6 seconds
        });


        // ... (Theme, UI, Navigation, Page Renderer functions remain similar, but use GLOBAL_CONFIG) ...
        
        // Theme management
        function applyTheme(theme) {
            document.body.classList.toggle('dark-mode', theme === 'dark');
            themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            localStorage.setItem('galaxyEarnTheme', theme);
        }

        function toggleTheme() {
            applyTheme(document.body.classList.contains('dark-mode') ? 'light' : 'dark');
        }

        // Update UI elements
        function updateUI() {
            profileNameDisplay.innerHTML = `
                ${currentUser.name}
                <i class="fas fa-check-circle verified-badge"></i>
                <button class="edit-name-btn" id="editNameBtn">
                    <i class="fas fa-pencil-alt"></i>
                </button>
            `;
            document.getElementById('editNameBtn').removeEventListener('click', promptForNewName); // Remove old listener
            document.getElementById('editNameBtn').addEventListener('click', promptForNewName); // Add new listener

            userPointsDisplay.innerHTML = `<i class="fas fa-money-bill-wave"></i> ‡ß≥ ${currentUser.points}`;
            const adsLeft = GLOBAL_CONFIG.ADS_PER_DAY_LIMIT - currentUser.adsWatchedToday;
            adsWatchedTodayEl.textContent = currentUser.adsWatchedToday;
            adsLeftTodayEl.textContent = Math.max(0, adsLeft);
            totalAdsWatchedEl.textContent = currentUser.totalAdsWatchedLifetime;

            if (currentUser.photoUrl) {
                profilePic.src = currentUser.photoUrl;
            }

            const watchBtn = document.getElementById('watchDailyAdBtn');
            if (watchBtn) {
                watchBtn.disabled = (adsLeft <= 0);
                watchBtn.textContent = adsLeft <= 0 ? 'Daily Limit Reached' : `<i class="fas fa-play"></i> Watch Ad & Earn ‡ß≥ ${GLOBAL_CONFIG.POINTS_PER_AD}`;
            }
        }

        function promptForNewName() {
            const newName = prompt("Enter your new name:", currentUser.name);
            if (newName && newName.trim()) {
                currentUser.name = newName.trim();
                updateUI();
                saveUserState();
                showToast("Name updated successfully!");
            }
        }

        // Navigation function
        function navigateTo(page) {
            // Check if navigating to admin panel
            if (page.startsWith('admin-')) {
                // Check if current user is admin (requires Firebase Auth to be initialized)
                if (auth.currentUser && ADMIN_UIDS.includes(auth.currentUser.uid)) {
                    appContainer.style.display = 'none';
                    document.getElementById('admin-dashboard').style.display = 'block';
                    adminNavigateTo(page);
                } else {
                    appContainer.style.display = 'none';
                    document.getElementById('admin-login-view').style.display = 'flex';
                }
                return;
            }

            // Standard WebApp Navigation
            if (document.getElementById('admin-dashboard').style.display !== 'none' || document.getElementById('admin-login-view').style.display !== 'none') {
                 // If admin panel is visible, hide it first
                 document.getElementById('admin-dashboard').style.display = 'none';
                 document.getElementById('admin-login-view').style.display = 'none';
                 appContainer.style.display = 'block';
            }

            const currentActiveNavItem = document.querySelector('.bottom-nav .nav-item.active');
            if (currentActiveNavItem) {
                currentActiveNavItem.classList.remove('active');
            }
            const activeNavItem = document.querySelector(`.nav-item[data-page="${page}"]`);
            if (activeNavItem) activeNavItem.classList.add('active');

            const pageRenderers = {
                'home': renderHomePage,
                'tasks': renderTasksPage,
                'bonus': renderBonusPage,
                'withdraw': renderWithdrawPage,
                'referral': renderReferralPage
            };

            if (pageRenderers[page]) pageRenderers[page]();
            updateUI();
        }

        // Page renderers
        function renderHomePage() {
            mainContent.innerHTML = `
                <div class="task-card">
                    <h2 class="section-title">
                        <i class="fas fa-home"></i> Welcome
                    </h2>
                    <p class="task-description">
                        Welcome to ${APP_NAME}, ${currentUser.name.split(' ')[0]}! Start earning ‡ß≥ Taka by completing tasks, watching ads, and inviting friends.
                    </p>
                    <div class="stats-display" style="justify-content: space-between; margin-top: 20px; gap: 8px;">
                        <div class="stat-item" style="flex: 1; margin: 0 4px;">
                            <div class="stat-value">${GLOBAL_CONFIG.ADS_PER_DAY_LIMIT - currentUser.adsWatchedToday}</div>
                            <div class="stat-label">Ads Left</div>
                        </div>
                        <div class="stat-item" style="flex: 1; margin: 0 4px;">
                            <div class="stat-value">‡ß≥ ${currentUser.points}</div>
                            <div class="stat-label">Total Taka</div>
                        </div>
                        <div class="stat-item" style="flex: 1; margin: 0 4px;">
                            <div class="stat-value">${currentUser.referredUsers ? currentUser.referredUsers.length : 0}</div>
                            <div class="stat-label">Referrals</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <a href="#" target="_blank" class="btn btn-secondary" onclick="event.preventDefault(); showToast('Channel Link Not Available');">
                        <i class="fab fa-telegram-plane"></i> Join Our Channel
                    </a>
                </div>
                <div class="developer-footer">
                    Developed by Floki
                </div>`;
        }

        function renderTasksPage() {
            const adsLeft = GLOBAL_CONFIG.ADS_PER_DAY_LIMIT - currentUser.adsWatchedToday;
            const progressPercent = (currentUser.adsWatchedToday / GLOBAL_CONFIG.ADS_PER_DAY_LIMIT) * 100;
            mainContent.innerHTML = `
                <div class="task-card">
                    <div class="task-header">
                        <div class="task-icon">
                            <i class="fas fa-ad"></i>
                        </div>
                        <div class="task-title">Watch Ads</div>
                        <div class="reward-badge">+‡ß≥ ${GLOBAL_CONFIG.POINTS_PER_AD}</div>
                    </div>
                    <p class="task-description">
                        Watch short video ads to earn ‡ß≥ Taka. You can watch exactly **${GLOBAL_CONFIG.ADS_PER_DAY_LIMIT} ads per day**. Each ad rewards **‡ß≥ ${GLOBAL_CONFIG.POINTS_PER_AD}**.
                    </p>
                    <div class="progress-container">
                        <div class="progress-text">
                            <span>${currentUser.adsWatchedToday}/${GLOBAL_CONFIG.ADS_PER_DAY_LIMIT} watched</span>
                            <span>${adsLeft} left</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="watchDailyAdBtn" ${adsLeft <= 0 ? 'disabled' : ''}>
                        <i class="fas fa-play"></i> Watch Ad & Earn ‡ß≥ ${GLOBAL_CONFIG.POINTS_PER_AD}
                    </button>
                </div>
                <div class="developer-footer">
                    Developed by Floki
                </div>`;
            if (adsLeft > 0) {
                document.getElementById('watchDailyAdBtn').addEventListener('click', handleWatchDailyAd);
            }
        }

        function renderBonusPage() {
            let channelsHtml = BONUS_CHANNELS.map(channel => {
                const isClaimed = currentUser.claimedBonuses.includes(channel.id);
                const linkIsValid = channel.link && channel.link !== '#' && channel.link !== ''; // Only use if link is valid
                return `
                    <li class="channel-item">
                        <div class="channel-info">
                            <div class="channel-icon">
                                <i class="${channel.icon}"></i>
                            </div>
                            <div>
                                <div class="channel-name">${channel.name}</div>
                                <div class="channel-reward">+‡ß≥ ${channel.reward}</div>
                            </div>
                        </div>
                        ${ linkIsValid ?
                            `<a href="${channel.link}" target="_blank" class="join-btn ${isClaimed ? 'claimed' : ''}" data-channel-id="${channel.id}" data-reward="${channel.reward}" onclick="handleBonusLinkClick(event, this)">
                                ${isClaimed ? 'Claimed' : 'Join'}
                            </a>` :
                            `<button class="join-btn ${isClaimed ? 'claimed' : ''}" onclick="event.preventDefault(); handleBonusLinkClick(event, this);" data-channel-id="${channel.id}" data-reward="${channel.reward}" ${isClaimed ? 'disabled' : ''}>
                                ${isClaimed ? 'Claimed' : 'Join'}
                            </button>`
                        }
                    </li>`;
            }).join('');

            mainContent.innerHTML = `
                <div class="task-card">
                    <h2 class="section-title">
                        <i class="fas fa-gift"></i> Bonus Rewards
                    </h2>
                    <p class="task-description">
                        Join our community channels to earn bonus ‡ß≥ Taka. Visit the link and return to claim your reward. **Note: All links have been disabled/removed as per request.**
                    </p>
                    <ul class="channel-list">${channelsHtml}</ul>
                </div>
                <div class="developer-footer">
                    Developed by Floki
                </div>`;
        }

        function renderWithdrawPage() {
            const currentReferrals = currentUser.referredUsers ? currentUser.referredUsers.length : 0;
            const referralNeeded = GLOBAL_CONFIG.WITHDRAWAL_REFERRAL_COUNT - currentReferrals;
            const canWithdraw = currentReferrals >= GLOBAL_CONFIG.WITHDRAWAL_REFERRAL_COUNT;
            
            let statusMessage = '';
            if (!canWithdraw) {
                statusMessage = `<p class="error-message"><i class="fas fa-exclamation-triangle"></i> Withdrawal requires **${GLOBAL_CONFIG.WITHDRAWAL_REFERRAL_COUNT}** active referrals. You need **${referralNeeded}** more.</p>`;
            } else {
                statusMessage = `<p class="success-message"><i class="fas fa-check-circle"></i> Referral requirement met! You have ${currentReferrals}/${GLOBAL_CONFIG.WITHDRAWAL_REFERRAL_COUNT} referrals.</p>`;
            }
            
            const paymentOptions = GLOBAL_CONFIG.PAYMENT_METHODS.map(method => `<option value="${method}">${method}</option>`).join('');

            mainContent.innerHTML = `
                <div class="task-card">
                    <h2 class="section-title">
                        <i class="fas fa-wallet"></i> Withdraw
                    </h2>
                    ${statusMessage}
                    <p class="task-description">
                        <b>Convert your ‡ß≥ Taka to real money.                  
 
    
 Minimum withdrawal is ‡ß≥ ${GLOBAL_CONFIG.MIN_WITHDRAW_POINTS}.</b>
                    </p>
                    <div class="input-group">
                        <label class="input-label">Amount (‡ß≥ Taka)</label>
                        <input type="number" id="withdrawAmountInput" class="input-field" placeholder="Enter amount">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Payment Method</label>
                        <select id="withdrawMethodSelect" class="select-field">
                            <option value="">Select method</option>
                            ${paymentOptions}
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Enter your Payment Account Number</label>
                        <input type="text" id="withdrawAccountInput" class="input-field" placeholder="Enter your number">
                    </div>
                    <button class="btn btn-primary" id="submitWithdrawBtn" ${!canWithdraw ? 'disabled' : ''}>
                        <i class="fas fa-paper-plane"></i> Submit Request
                    </button>
                    <p class="status-message" id="withdrawStatusMsg"></p>
                </div>
                <div class="developer-footer">
                    Developed by Floki
                </div>`;
            document.getElementById('submitWithdrawBtn').addEventListener('click', handleSubmitWithdrawal);
        }

        function renderReferralPage() {
            const referralLink = `${REFERRAL_BOT_LINK}?start=${currentUser.referralCode}`;
            const referredUsersCount = currentUser.referredUsers ? currentUser.referredUsers.length : 0;

            let referredUsersListHtml = '';
            // Simplified referral list rendering as we can't easily fetch all referred user names from a single call here
            if (referredUsersCount > 0) {
                referredUsersListHtml = `
                    <h3 style="margin: 20px 0 10px; font-size: 1rem; color: var(--text-secondary);">Your Referrals (${referredUsersCount})</h3>
                    <div class="referred-users">`;
                
                // Placeholder list items - replace with actual fetching if needed in a real app
                for (let i = 0; i < Math.min(5, referredUsersCount); i++) {
                    referredUsersListHtml += `
                        <div class="user-item">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-info">
                                <div class="user-name">Referred User ${i + 1}</div>
                                <div class="user-code">****</div>
                            </div>
                        </div>`;
                }
                
                if (referredUsersCount > 5) {
                    referredUsersListHtml += `<p class="text-center text-xs text-gray-500 mt-2">...and ${referredUsersCount - 5} more</p>`;
                }
                referredUsersListHtml += `</div>`;
            } else {
                referredUsersListHtml = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>No referrals yet</p>
                        <p style="font-size: 0.85rem; margin-top: 5px;">Share your link to earn more</p>
                    </div>`;
            }

            mainContent.innerHTML = `
                <div class="task-card">
                    <h2 class="section-title">
                        <i class="fas fa-share-alt"></i> Refer & Earn
                    </h6>
                    <p class="task-description">
                        Invite friends and earn ‡ß≥ ${GLOBAL_CONFIG.REFERRAL_BONUS_REFERRER} for each successful referral. They'll get ‡ß≥ ${GLOBAL_CONFIG.REFERRAL_BONUS_REFEREE} too! **(Withdrawal requires ${GLOBAL_CONFIG.WITHDRAWAL_REFERRAL_COUNT} referrals)**
                    </p>
                    <div class="referral-container">
                        <label class="input-label">Your Referral Code</label>
                        <div class="referral-input-group">
                            <input type="text" id="referralCodeDisplay" class="referral-input" value="${currentUser.referralCode}" readonly>
                            <button class="copy-btn" id="copyReferralCodeBtn">Copy</button>
                        </div>
                        <label class="input-label">Your Referral Link</label>
                        <div class="referral-input-group">
                            <input type="text" id="referralLinkDisplay" class="referral-input" value="${referralLink}" readonly>
                            <button class="copy-btn" id="copyReferralLinkBtn">Copy</button>
                        </div>
                        <button class="btn btn-secondary" id="shareReferralLinkBtn" style="margin-top: 15px; width: 100%;">
                            <i class="fas fa-share-alt"></i> Share Link
                        </button>
                    </div>
                    <div class="referral-stats">
                        <div class="stat-card">
                            <div class="stat-number">‡ß≥ ${GLOBAL_CONFIG.REFERRAL_BONUS_REFERRER}</div>
                            <div class="stat-title">Per Referral</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${referredUsersCount}</div>
                            <div class="stat-title">Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">‡ß≥ ${referredUsersCount * GLOBAL_CONFIG.REFERRAL_BONUS_REFERRER}</div>
                            <div class="stat-title">Earned</div>
                        </div>
                    </div>
                    ${referredUsersListHtml}
                </div>
                <div class="developer-footer">
                    Developed by Floki
                </div>`;

            document.getElementById('copyReferralCodeBtn').addEventListener('click', () => {
                const referralCodeInput = document.getElementById('referralCodeDisplay');
                referralCodeInput.select();
                document.execCommand('copy');
                showToast('Referral code copied!');
            });
            document.getElementById('copyReferralLinkBtn').addEventListener('click', () => {
                const referralLinkInput = document.getElementById('referralLinkDisplay');
                referralLinkInput.select();
                document.execCommand('copy');
                showToast('Referral link copied!');
            });
            document.getElementById('shareReferralLinkBtn').addEventListener('click', () => {
                if (navigator.share) {
                    navigator.share({
                        title: `${APP_NAME} - Earn ‡ß≥ Taka!`,
                        text: `Join ${APP_NAME} using my referral code ${currentUser.referralCode} and we both get bonus ‡ß≥ Taka!`,
                        url: referralLink,
                    }).catch((error) => console.log('Error sharing', error));
                } else {
                    const referralLinkInput = document.getElementById('referralLinkDisplay');
                    referralLinkInput.select();
                    document.execCommand('copy');
                    showToast('Link copied! Share it manually.');
                }
            });
        }

        // Ad handling
        let adWatchedSuccessfully = false;
        let adRewardPending = false;

        async function handleWatchDailyAd() {
            const today = new Date().toLocaleDateString();
            if (currentUser.lastAdWatchDate !== today) {
                currentUser.adsWatchedToday = 0;
                currentUser.lastAdWatchDate = today;
                await saveUserState();
            }

            if (currentUser.adsWatchedToday >= GLOBAL_CONFIG.ADS_PER_DAY_LIMIT) {
                showToast("Daily ad limit reached!");
                updateUI();
                return;
            }

            adWatchedSuccessfully = false;
            adRewardPending = true;
            openAdModal("Launching Ad...");
            adSpinner.style.display = 'block';
            adCloseBtn.style.display = 'none';
            adStatusMessage.textContent = "Please wait while we load the ad";

            if (MONETAG_AD_FUNCTION_NAME && typeof window[MONETAG_AD_FUNCTION_NAME] === 'function') {
                try {
                    const adPromise = window[MONETAG_AD_FUNCTION_NAME]();
                    if (adPromise && typeof adPromise.then === 'function') {
                        adModalTitle.textContent = "Ad Playing";
                        adStatusMessage.textContent = "Please watch the full ad to claim your reward";
                        adPromise.then(() => {
                            adWatchedSuccessfully = true;
                            if (adRewardPending) {
                                adSpinner.style.display = 'none';
                                adStatusMessage.textContent = "Ad completed! Close to claim your reward";
                                adCloseBtn.style.display = 'block';
                            }
                        }).catch(error => {
                            handleAdError("Ad closed too soon or error occurred. No Taka awarded.");
                            console.error("Monetag ad error:", error);
                        });
                    } else {
                        // Simulation for the original ad code structure not returning a promise
                        setTimeout(() => {
                            if (adRewardPending) {
                                adSpinner.style.display = 'none';
                                adStatusMessage.textContent = "Ad completed! Close to claim your reward";
                                adCloseBtn.style.display = 'block';
                                adWatchedSuccessfully = true;
                            }
                        }, 7000);
                    }
                } catch (error) {
                    handleAdError("Error loading ad. Please try again.");
                    console.error("Monetag ad execution error:", error);
                }
            } else {
                showToast("Ad service not fully integrated. Simulating ad watch...");
                adModalTitle.textContent = "Simulating Ad...";
                adStatusMessage.textContent = "Ad will finish in 5 seconds (simulation).";
                setTimeout(() => {
                    if (adRewardPending) {
                        adSpinner.style.display = 'none';
                        adStatusMessage.textContent = "Simulated ad completed! Close to claim your reward";
                        adCloseBtn.style.display = 'block';
                        adWatchedSuccessfully = true;
                    }
                }, 5000);
            }
        }

        function handleAdError(errorMessage) {
            if (adRewardPending) {
                adSpinner.style.display = 'none';
                adStatusMessage.textContent = errorMessage;
                adModalTitle.textContent = "Ad Error";
                adCloseBtn.textContent = "Close";
                adCloseBtn.style.display = 'block';
                adWatchedSuccessfully = false;
                adRewardPending = false;
            }
        }

        function openAdModal(title) {
            adModalTitle.textContent = title;
            adCloseBtn.textContent = "Close & Claim Reward";
            adModal.classList.add('show');
        }

        async function closeAdModalAndReward() {
            adModal.classList.remove('show');
            if (adWatchedSuccessfully && adRewardPending) {
                currentUser.points += GLOBAL_CONFIG.POINTS_PER_AD;
                currentUser.adsWatchedToday++;
                currentUser.totalAdsWatchedLifetime++;
                currentUser.lastAdWatchDate = new Date().toLocaleDateString();
                await saveUserState(); // Save to Firebase/Local
                showToast(`+‡ß≥ ${GLOBAL_CONFIG.POINTS_PER_AD} earned!`);
            } else if (adRewardPending && !adWatchedSuccessfully) {
                showToast("Ad not completed. No Taka awarded.");
            }
            adRewardPending = false;
            adWatchedSuccessfully = false;
        }

        // Bonus channel handling (Links are now disabled)
        async function handleBonusLinkClick(event, buttonElement) {
            const channelId = buttonElement.dataset.channelId;
            const reward = parseInt(buttonElement.dataset.reward);
            const link = buttonElement.href;
            const isClaimed = currentUser.claimedBonuses.includes(channelId);

            if (isClaimed) {
                showToast("Bonus already claimed!");
                return;
            }

            event.preventDefault();
            
            if (link && link !== '#' && link !== '') {
                const newWindow = window.open(link, '_blank');
            } else {
                 showToast("No active link for this bonus. Claiming after a brief wait.", 5000);
            }


            buttonElement.textContent = 'Verifying...';
            buttonElement.disabled = true;

            setTimeout(async () => {
                if (!currentUser.claimedBonuses.includes(channelId)) {
                    currentUser.points += reward;
                    currentUser.claimedBonuses.push(channelId);
                    await saveUserState(); // Save to Firebase/Local
                    buttonElement.textContent = 'Claimed';
                    buttonElement.classList.add('claimed');
                    showToast(`+‡ß≥ ${reward} bonus claimed!`);
                } else {
                     buttonElement.textContent = 'Claimed';
                     buttonElement.classList.add('claimed');
                }
                buttonElement.disabled = false;
            }, 7000);
        }

        // Withdrawal handling
        async function handleSubmitWithdrawal() {
            const amount = parseInt(document.getElementById('withdrawAmountInput').value);
            const method = document.getElementById('withdrawMethodSelect').value;
            const account = document.getElementById('withdrawAccountInput').value.trim();
            const statusMsg = document.getElementById('withdrawStatusMsg');
            const currentReferrals = currentUser.referredUsers ? currentUser.referredUsers.length : 0;

            statusMsg.className = 'status-message';
            statusMsg.textContent = '';

            if (!currentUser.telegramId || !userDocRef) {
                statusMsg.textContent = `Please launch the app via Telegram to submit a withdrawal.`;
                statusMsg.classList.add('error-message');
                return;
            }

            if (currentReferrals < GLOBAL_CONFIG.WITHDRAWAL_REFERRAL_COUNT) {
                 statusMsg.textContent = `You must have ${GLOBAL_CONFIG.WITHDRAWAL_REFERRAL_COUNT} referrals to withdraw. You have ${currentReferrals}.`;
                 statusMsg.classList.add('error-message');
                 return;
            }

            if (isNaN(amount) || amount <= 0) {
                statusMsg.textContent = "Please enter a valid amount.";
                statusMsg.classList.add('error-message');
                return;
            }
            if (amount < GLOBAL_CONFIG.MIN_WITHDRAW_POINTS) {
                statusMsg.textContent = `Minimum withdrawal is ‡ß≥ ${GLOBAL_CONFIG.MIN_WITHDRAW_POINTS}.`;
                statusMsg.classList.add('error-message');
                return;
            }
            if (amount > currentUser.points) {
                statusMsg.textContent = "You don't have enough Taka.";
                statusMsg.classList.add('error-message');
                return;
            }
            if (!method) {
                statusMsg.textContent = "Please select a payment method.";
                statusMsg.classList.add('error-message');
                return;
            }
            if (!account || account.length < 10) {
                statusMsg.textContent = "Please enter a valid account number.";
                statusMsg.classList.add('error-message');
                return;
            }

            // Deduct points locally first
            currentUser.points -= amount;
            updateUI();
            await saveUserState(); // Update balance on Firebase

            // Add withdrawal request to Firestore (for admin panel)
            try {
                await addDoc(collection(db, "withdrawals"), {
                    userId: currentUser.userId,
                    userName: currentUser.name,
                    telegramId: currentUser.telegramId,
                    amount: amount,
                    method: method,
                    paymentDetail: account,
                    status: 'pending',
                    requestedAt: serverTimestamp()
                });
            } catch(error) {
                console.error("Error creating withdrawal request in Firestore:", error);
            }

            const escapeMarkdown = (text) => {
                // Escape special characters for MarkdownV2
                return text.replace(/([_*\[\]()~`>#+\-=|{}.!])/g, '\\$1');
            };

            const withdrawalDetails = `
üîî *ùó°ùó≤ùòÑ ùó™ùó∂ùòÅùóµùó±ùóøùóÆùòÑùóÆùóπ ùó•ùó≤ùóæùòÇùó≤ùòÄùòÅ * üîî
------------------------------------
üïµÔ∏è *ùóîùóΩùóΩ ùó°ùóÆùó∫ùó≤ :* \`${escapeMarkdown(APP_NAME)}\`
üë§ *ùó®ùòÄùó≤ùóø ùó°ùóÆùó∫ùó≤ :* \`${escapeMarkdown(currentUser.name)}\`
üí∞ *ùóîùó∫ùóºùòÇùóªùòÅ :* ‡ß≥ ${amount}
üí≥ *ùó†ùó≤ùòÅùóµùóºùó± :* ${escapeMarkdown(method)}
üè¶ *ùóîùó∞ùó∞ùóºùòÇùóªùòÅ :* \`${escapeMarkdown(account)}\`
------------------------------------
üìä *Referrals :* ${currentReferrals}/${GLOBAL_CONFIG.WITHDRAWAL_REFERRAL_COUNT}
‚ôé ùó†ùóÆùó∂ùóª ùóïùóÆùóπùóÆùóªùó∞ùó≤ : ‡ß≥ ${currentUser.points}
üëÄ ùóßùóºùòÅùóÆùóπ ùóîùó±ùòÄ ùó™ùóÆùòÅùó∞ùóµùó≤ùó± : ${currentUser.totalAdsWatchedLifetime}
------------------------------------
‚è∞ *ùó™ùó∂ùòÅùóµùó±ùóøùóøùóÆùòÑùóÆùóπ ùóßùó∂ùó∫ùó≤ :* ${new Date().toLocaleString('en-GB', { timeZone: 'Asia/Dhaka' })}
            `;

            sendToTelegram(withdrawalDetails);

            statusMsg.textContent = "Withdrawal request submitted successfully! Payment will be processed shortly. Check the Admin Panel!";
            statusMsg.classList.add('success-message');
            document.getElementById('withdrawAmountInput').value = "";
            document.getElementById('withdrawMethodSelect').value = "";
            document.getElementById('withdrawAccountInput').value = "";
        }

        // Telegram integration
        function sendToTelegram(message) {
            if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
                console.warn("Telegram Bot not configured. Message not sent.");
                return;
            }

            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chat_id: TELEGRAM_CHAT_ID,
                    text: message,
                    parse_mode: 'MarkdownV2'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.ok) {
                    console.warn('Telegram API error:', data.description);
                    fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: TELEGRAM_CHAT_ID,
                            text: message.replace(/[*_`\[\]()~>#+\-=|{}.!]/g, '')
                        })
                    }).then(res => res.json()).then(plainData => {
                        if (!plainData.ok) {
                            console.error('Plain text Telegram message failed:', plainData.description);
                        }
                    });
                }
            })
            .catch(error => console.error('Error sending Telegram message:', error));
        }

        function sendTelegramReferralNotification(refereeName, refereeCode, referrerName, referrerCode) {
            if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
                console.warn("Telegram Bot for referral notification not configured. Notification not sent.");
                return;
            }

            const escapeMarkdown = (text) => {
                return text.replace(/([_*\[\]()~`>#+\-=|{}.!])/g, '\\$1');
            };

            const message = `
üéâ *New Referral Bonus!* üéâ
------------------------------------
üë• *New User:* \`${escapeMarkdown(refereeName)}\` (Code: \`${escapeMarkdown(refereeCode)}\`)
üåü *Received:* ‡ß≥ ${GLOBAL_CONFIG.REFERRAL_BONUS_REFEREE}
Referral From:
üë§ *Referrer:* \`${escapeMarkdown(referrerName)}\` (Code: \`${escapeMarkdown(referrerCode)}\`)
üåü *Received:* ‡ß≥ ${GLOBAL_CONFIG.REFERRAL_BONUS_REFERRER}
------------------------------------
‚è∞ *Timestamp:* ${new Date().toLocaleString('en-GB', { timeZone: 'Asia/Dhaka' })}
            `;

            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chat_id: TELEGRAM_CHAT_ID,
                    text: message,
                    parse_mode: 'MarkdownV2'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.ok) {
                    console.warn('Telegram API error for referral notification:', data.description);
                    fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: TELEGRAM_CHAT_ID,
                            text: message.replace(/[*_`\[\]()~>#+\-=|{}.!]/g, '')
                        })
                    });
                }
            })
            .catch(error => console.error('Error sending referral Telegram message:', error));
        }

        // --- Admin Panel Logic ---

        const loginView = document.getElementById('admin-login-view');
        const dashboardView = document.getElementById('admin-dashboard');

        window.onload = () => {
            lucide.createIcons();
            setupAdminEventListeners();
            
            // Check for admin login status only after app initialization
            onAuthStateChanged(auth, (user) => {
                const tgUser = window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe.user;
                if (user && ADMIN_UIDS.includes(user.uid)) {
                    // Logged in as Admin
                    appContainer.style.display = 'none';
                    loginView.style.display = 'none';
                    dashboardView.style.display = 'block';
                    adminNavigateTo('admin-dashboard-page');
                    loadDashboardData();
                    loadUsers();
                    loadWithdrawals();
                    loadSettings();
                } else if (tgUser) {
                    // Logged in as regular WebApp user
                    appContainer.style.display = 'block';
                    loginView.style.display = 'none';
                    dashboardView.style.display = 'none';
                } else {
                     // Guest/Login view fallback (If Admin panel is the entry point)
                     loginView.style.display = 'flex';
                     appContainer.style.display = 'none';
                     dashboardView.style.display = 'none';
                }
            });
        };

        function adminNavigateTo(pageId) {
            document.querySelectorAll('.admin-page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.admin-sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === pageId) link.classList.add('active');
            });
        }

        function setupAdminEventListeners() {
            document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
            document.getElementById('admin-logout-btn').addEventListener('click', () => signOut(auth).then(() => window.location.reload()));
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
{request.paymentDetail || 'N/A'}</td><td>${requestedDate}</td>
                        <td class="space-x-2">
                            <button class="admin-btn admin-btn-success text-xs" onclick="window.handleWithdrawal('${docSnap.id}', 'approved')">‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®</button>
                            <button class="admin-btn admin-btn-danger text-xs" onclick="window.handleWithdrawal('${docSnap.id}', 'rejected')">‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®</button>
                        </td>
                    </tr>`;
                    withdrawalsTableBody.innerHTML += row;
                });
            });
        }

        async function loadSettings() {
            const configRef = doc(db, "config", "main");
            const docSnap = await getDoc(configRef);
            if (docSnap.exists()) {
                const config = docSnap.data();
                document.getElementById('min-withdrawal').value = config.minWithdrawal || '';
                document.getElementById('daily-ad-limit').value = config.dailyAdLimit || '';
                document.getElementById('ad-reward-points').value = config.adRewardPoints || '';
                document.getElementById('ref-withdraw-count').value = config.refWithdrawCount || '';
